<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard ‚Äì RentToGo</title>
  <link rel="stylesheet" href="/css/styles.css" />
  <style>
    /* keep all your CSS exactly as before (omitted here for brevity) */
    /* paste the CSS from your original file between these style tags */
  </style>
</head>
<body>
  <header class="topbar">
    <div class="logo">RentToGo</div>
    <nav>
      <a th:href="@{/}">Home</a>
      <a th:href="@{/dashboard}">Dashboard</a>
      <form th:action="@{/logout}" method="post" style="display:inline">
        <button type="submit" class="logout-btn" style="background:transparent;border:0;padding:8px 16px;cursor:pointer;">Logout</button>
      </form>
    </nav>
  </header>

  <main class="dashboard-main">
    <div class="dashboard-header">
      <div class="dashboard-title">
        <h1>Dashboard</h1>
        <p class="tagline">Manage and explore available accommodations</p>
      </div>
      <div class="user-info">
        <div class="user-avatar" th:text="${currentUserName != null ? ${#strings.substring(currentUserName,0,1)} : 'U'}">D</div>
        <div class="user-details">
          <h3 id="userName" th:text="${currentUserName}">Demo User</h3>
          <p id="userEmail" th:text="${#authentication?.principal}">demo@renttogo.com</p>
        </div>
        <!-- using form-based logout above; keep visual logout too -->
      </div>
    </div>

    <div class="dashboard-stats">
      <div class="stat-card">
        <div class="stat-icon">üè†</div>
        <div class="stat-info">
          <h3 th:id="totalPGs" th:text="${accommodations != null ? accommodations.size() : 0}">0</h3>
          <p>Total PGs</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">‚úÖ</div>
        <div class="stat-info">
          <h3 th:id="availablePGs" th:text="${#lists.size(accommodations != null ? (#streams.create(accommodations).filter(a -> a.availableRooms > 0).toList()) : {})}">0</h3>
          <p>Available</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">‚úì</div>
        <div class="stat-info">
          <h3 th:text="${accommodations != null ? accommodations.size() : 0}">0</h3>
          <p>Verified</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üìç</div>
        <div class="stat-info">
          <h3 th:text="${#lists.size(#arrays.asList(accommodations).?[city])}">5</h3>
          <p>Locations</p>
        </div>
      </div>
    </div>

    <div class="filters-section">
      <h3 style="margin: 0 0 16px; font-size: 18px;">üîç Filter & Sort</h3>
      <div class="filters-row">
        <div class="filter-group">
          <label>Location</label>
          <select id="locationFilter">
            <option value="all">All Locations</option>
            <option th:each="city : ${#lists.arrayList(accommodations).!{city}.stream().distinct().toList()}"
                    th:value="${city.toLowerCase()}"
                    th:text="${city}">City</option>
          </select>
        </div>

        <div class="filter-group">
          <label>Availability</label>
          <select id="availabilityFilter">
            <option value="all">All</option>
            <option value="available">Available Only</option>
            <option value="full">Full Only</option>
          </select>
        </div>

        <div class="filter-group">
          <label>Sort By</label>
          <select id="sortFilter">
            <option value="distance">Distance (Nearest)</option>
            <option value="price-low">Price (Low to High)</option>
            <option value="price-high">Price (High to Low)</option>
            <option value="rooms">Available Rooms</option>
          </select>
        </div>

        <div class="filter-group">
          <label>Max Price</label>
          <input type="number" id="priceFilter" placeholder="‚Çπ10,000" />
        </div>

        <button class="filter-btn" onclick="applyFilters()">Apply Filters</button>
      </div>
    </div>

    <div class="cards">
      <div class="grid" id="pgGrid">
        <div th:each="pg : ${accommodations}" class="accommodation-card"
             th:attr="data-location=${pg.city.toLowerCase()}, data-distance=${pg.latitude != null && pg.longitude != null ? 0 : 9999}, data-price=${pg.pricePerMonth}, data-rooms=${pg.availableRooms}">
          <div class="card-header">
            <h3 th:text="${pg.name}">PG Name</h3>
            <div class="card-badges">
              <span th:if="${pg.availableRooms > 0}" class="badge-available">Available</span>
              <span th:if="${pg.availableRooms == 0}" class="badge-full">Full</span>
              <span class="badge-verified">‚úì Verified</span>
            </div>
          </div>

          <div class="card-content">
            <div class="card-detail">
              <span class="detail-icon">üìç</span>
              <p th:text="${pg.address}">Address</p>
            </div>

            <span class="distance-tag" th:text="'üìè ' + (${#numbers.formatDecimal(#numbers.formatDecimal( (pg.latitude != null && pg.longitude != null) ? 0.0 : 9999.0, 1, 1) , 1, 1)} ) + ' km away'">üìè 1.2 km away</span>

            <div class="card-info-grid">
              <div class="info-item">
                <span class="info-icon">üí∞</span>
                <div class="info-text">
                  <span class="info-label">Monthly Rent</span>
                  <span class="info-value" th:text="'‚Çπ' + ${pg.pricePerMonth}">‚Çπ0</span>
                </div>
              </div>

              <div class="info-item">
                <span class="info-icon">üõèÔ∏è</span>
                <div class="info-text">
                  <span class="info-label">Available Rooms</span>
                  <span class="info-value" th:text="${pg.availableRooms}">0</span>
                </div>
              </div>
            </div>
          </div>

          <div class="card-actions">
            <a th:href="@{'/accommodation/' + ${pg.id}}" class="btn-primary">View Details</a>
            <a th:href="'tel:' + ${pg.contactNumber}" class="btn-secondary">Contact Owner</a>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer>
    <p>¬© 2025 RentToGo. Your trusted PG and hostel finder.</p>
  </footer>

  <script>
    // keep client-side filter/sort code ‚Äî but remove any sessionStorage-based auth checks
    function applyFilters() {
      const location = document.getElementById('locationFilter').value;
      const availability = document.getElementById('availabilityFilter').value;
      const sortBy = document.getElementById('sortFilter').value;
      const maxPrice = document.getElementById('priceFilter').value;

      const cards = Array.from(document.querySelectorAll('.accommodation-card'));
      let visibleCards = [];

      cards.forEach(card => {
        const cardLocation = card.getAttribute('data-location');
        const cardPrice = parseFloat(card.getAttribute('data-price'));
        const cardRooms = parseInt(card.getAttribute('data-rooms'));

        let show = true;

        if (location !== 'all' && cardLocation !== location) show = false;
        if (availability === 'available' && cardRooms === 0) show = false;
        if (availability === 'full' && cardRooms > 0) show = false;
        if (maxPrice && cardPrice > parseFloat(maxPrice)) show = false;

        card.style.display = show ? 'flex' : 'none';
        if (show) visibleCards.push(card);
      });

      if (sortBy === 'distance') {
        visibleCards.sort((a,b) => parseFloat(a.getAttribute('data-distance')) - parseFloat(b.getAttribute('data-distance')));
      } else if (sortBy === 'price-low') {
        visibleCards.sort((a,b) => parseFloat(a.getAttribute('data-price')) - parseFloat(b.getAttribute('data-price')));
      } else if (sortBy === 'price-high') {
        visibleCards.sort((a,b) => parseFloat(b.getAttribute('data-price')) - parseFloat(a.getAttribute('data-price')));
      } else if (sortBy === 'rooms') {
        visibleCards.sort((a,b) => parseInt(b.getAttribute('data-rooms')) - parseInt(a.getAttribute('data-rooms')));
      }

      const grid = document.getElementById('pgGrid');
      visibleCards.forEach(card => grid.appendChild(card));

      document.getElementById('totalPGs').textContent = visibleCards.length;
      const availableCount = visibleCards.filter(c => parseInt(c.getAttribute('data-rooms')) > 0).length;
      document.getElementById('availablePGs').textContent = availableCount;
    }
  </script>
</body>
</html>
